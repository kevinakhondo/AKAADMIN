<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Review Moderation</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        button { padding: 6px 12px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #45a049; }
        .error { color: red; text-align: center; display: none; }
        .loading { text-align: center; }
    </style>
</head>
<body>
    <h1>Review Moderation</h1>
    <p class="error" id="error-message"></p>
    <p class="loading" id="loading">Loading reviews...</p>
    <table id="reviews-table" style="display: none;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Text</th>
                <th>Rating</th>
                <th>Approved</th>
                <th>Created At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        const ADMIN_TOKEN = '1eb4e857ccb5616aa7b3450361826f94'; // Replace with your actual token
        const API_URL = 'https://a-k-analytics-backend.onrender.com';

        async function loadReviews() {
            const errorMessage = document.getElementById('error-message');
            const loading = document.getElementById('loading');
            const table = document.getElementById('reviews-table');
            const tbody = table.querySelector('tbody');

            try {
                errorMessage.style.display = 'none';
                loading.style.display = 'block';
                table.style.display = 'none';

                const response = await fetch(`${API_URL}/api/reviews/all`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_TOKEN}` }
                });
                if (!response.ok) throw new Error('Failed to fetch reviews');
                const reviews = await response.json();

                tbody.innerHTML = '';
                reviews.forEach(review => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${review.name}</td>
                        <td>${review.text}</td>
                        <td>${review.rating}</td>
                        <td>${review.approved}</td>
                        <td>${new Date(review.createdAt).toLocaleString()}</td>
                        <td><button onclick="toggleApproval('${review._id}', ${!review.approved})">
                            ${review.approved ? 'Unapprove' : 'Approve'}
                        </button></td>
                    `;
                    tbody.appendChild(row);
                });

                loading.style.display = 'none';
                table.style.display = 'table';
            } catch (error) {
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error loading reviews: ' + error.message;
            }
        }

        async function toggleApproval(id, approved) {
            const errorMessage = document.getElementById('error-message');
            try {
                errorMessage.style.display = 'none';
                const response = await fetch(`${API_URL}/api/reviews/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_TOKEN}`
                    },
                    body: JSON.stringify({ approved })
                });
                if (!response.ok) throw new Error('Failed to update review');
                loadReviews();
            } catch (error) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error updating review: ' + error.message;
            }
        }

        loadReviews();
    </script>
</body>
</html>